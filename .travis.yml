language: generic
branches:
  only:
    - devel-gcc-5.4.0
    - devel-gcc-8.2.0
os:
  - linux
github_token: $GH_TOKEN

sudo: required
services:
  - docker

# set up docker image
before_install:
  - docker pull compbiocore/conda-build:latest
  - docker run --name cbc -it -d compbiocore/conda-build:latest /bin/bash
  - docker exec cbc sh -c 'cd /home/conda; git clone --branch=devel-gcc-8.2.0 https://github.com/compbiocore/conda-recipes.git'

stages:
  - name: individual
  - if: branch = devel-gcc-*
  
  - script:
    - echo $TRAVIS_BRANCH
    - docker exec cbc sh -c "cd /home/conda/conda-recipes; python /home/conda/conda-recipes/ci_scripts/build.py $TRAVIS_COMMIT_RANGE -c compbiocore -e /home/conda/conda-recipes/ci_scripts/environment.yml -r /home/conda/conda-recipes/README.md -al $ANACONDA_LOGIN -ap $ANACONDA_PASSWORD"
    #- docker exec cbc sh -c "cd /home/conda/conda-recipes; git commit -a -m 'updating conflicting recipes'; git push 'https://${GH_TOKEN}@github.com/compbiocore/conda-recipes.git' install"

  - name: all
  - if: branch = all-recipe-build
  - script:
    - echo $TRAVIS_BRANCH
    - docker exec cbc sh -c "cd /home/conda/conda-recipes; python /home/conda/conda-recipes/ci_scripts/build-all.py -c compbiocore -e /home/conda/conda-recipes/ci_scripts/environment.yml -r /home/conda/conda-recipes/README.md -d ./recipes"

after_install:
  - docker stop cbc
  - docker rm cbc
  # should become docker exec only on the modified recipe later on.
